"0","# Load subject info"
"0","infant_anthropometrics = read.csv(""./Data/BMI/infant_anthropometrics.csv"") %>% as_tibble()"
"0",""
"0","# Faeces subject info"
"0","sampleInfo = read.csv(""./Data/BMI/faeces_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""Sample"", ""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0","sampleInfo = sampleInfo %>% left_join(infant_anthropometrics %>% select(RCID, whz.6m))"
"1","[38;5;255mJoining with `by = join_by(RCID)`[39m
"
"0","subjectMeta_faeces = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis, whz.6m) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0","subjectMeta_faeces = subjectMeta_faeces[-90,]"
"0",""
"0","# Milk subject info"
"0","sampleInfo = read.csv(""./Data/BMI/milk_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""Sample"", ""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0","subjectMeta = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0","subjectMeta_milk = subjectMeta %>% left_join(subjectMeta_faeces)"
"1","[38;5;255mJoining with `by = join_by(subject, BMI, BMI.group, C.section, Secretor, Lewis)`[39m
"
"0","# Milk metab subject info"
"0","sampleInfo = read.csv(""./Data/BMI/milkMetab_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0","subjectMeta = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0","subjectMeta_milkMetab = subjectMeta %>% left_join(subjectMeta_faeces %>% select(subject, whz.6m))"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"0","# Identify shared subjects"
"0","sharedSubjects = intersect(intersect(subjectMeta_faeces$subject, subjectMeta_milk$subject), subjectMeta_milkMetab$subject)"
"0","homogenized_subjectMeta_bmi = subjectMeta_faeces %>% filter(subject %in% sharedSubjects) %>% arrange(subject)"
"0","homogenized_subjectMeta_whz = homogenized_subjectMeta_bmi %>% filter(whz.6m != ""NA"")"
"0",""
"0","# Faecal microbiome"
"0","df = read.csv(""./Data/BMI/faecesCounts.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","taxonomy = read.csv(""./Data/BMI/newTaxonomy_faeces.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","sampleInfo = read.csv(""./Data/BMI/faeces_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""Sample"", ""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0",""
"0","subjectMeta = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0",""
"0","# Filter taxa to taxa with at least 1 non-zero value"
"0","featureMask = colSums(df) > 0"
"0","df = df[,featureMask]"
"0","taxonomy = taxonomy[featureMask,]"
"0",""
"0","# Filter based on sparsity"
"0","threshold = 0.75"
"0",""
"0","sparsity = colSums(df==0) / nrow(df)"
"0",""
"0","featureSelection = sparsity <= threshold"
"0","taxonomy_filtered = taxonomy[featureSelection,]"
"0","df_filtered = df[,featureSelection]"
"0",""
"0","# CLR"
"0","df_clr = t(apply(df_filtered+1, 1, function(x){log(x / compositions::geometricmean(x))})) %>% as_tibble()"
"0",""
"0","# Make into cube"
"0","I = length(unique(sampleInfo$subject))"
"0","J = ncol(df_clr)"
"0","K = length(unique(sampleInfo$Days))"
"0","X = array(0L, c(I,J,K))"
"0","timepoints = sampleInfo %>% arrange(Days) %>% select(Days) %>% unique() %>% pull()"
"0",""
"0","for(k in 1:K){"
"0","  Day = timepoints[k]"
"0","  X[,,k] = cbind(df_clr, sampleInfo) %>% as_tibble() %>% mutate(subject=as.character(subject)) %>% filter(Days == Day) %>% select(c(colnames(df_clr),subject)) %>% right_join(subjectMeta) %>% arrange(subject) %>% select(-colnames(subjectMeta)) %>% as.matrix()"
"0","}"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"0","# Mask based on shared subjects for BMI and WHZ"
"0","X_bmi = X[subjectMeta$subject %in% homogenized_subjectMeta_bmi$subject,,]"
"0","X_whz = X[subjectMeta$subject %in% homogenized_subjectMeta_whz$subject,,]"
"0",""
"0","# Center and scale"
"0","X_bmi_cnt = parafac4microbiome::multiwayCenter(X_bmi, mode=1)"
"0","X_bmi_cnt_scl = parafac4microbiome::multiwayScale(X_bmi_cnt, mode=2)"
"0",""
"0","X_whz_cnt = parafac4microbiome::multiwayCenter(X_whz, mode=1)"
"0","X_whz_cnt_scl = parafac4microbiome::multiwayScale(X_whz_cnt, mode=2)"
"0",""
"0","# Save"
"0","faeces_df_bmi = X_bmi_cnt_scl"
"0","faeces_df_whz = X_whz_cnt_scl"
"0","faeces_taxonomy = taxonomy_filtered"
"0","faeces_timepoints = timepoints"
"0",""
"0","# Milk microbiome"
"0","df = read.csv(""./Data/BMI/milkCounts.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","taxonomy = read.csv(""./Data/BMI/newTaxonomy_milk.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","sampleInfo = read.csv(""./Data/BMI/milk_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""Sample"", ""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0",""
"0","# Make subject metadata"
"0","subjectMeta = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0",""
"0","# Filter taxa to taxa with at least 1 non-zero value"
"0","featureMask = colSums(df) > 0"
"0","df = df[,featureMask]"
"0","taxonomy = taxonomy[featureMask,]"
"0",""
"0","# Filter based on sparsity"
"0","threshold = 0.85"
"0",""
"0","sparsity = colSums(df==0) / nrow(df)"
"0",""
"0","featureSelection = sparsity <= threshold"
"0","taxonomy_filtered = taxonomy[featureSelection,]"
"0","df_filtered = df[,featureSelection]"
"0",""
"0","# CLR"
"0","df_clr = t(apply(df_filtered+1, 1, function(x){log(x / compositions::geometricmean(x))})) %>% as_tibble()"
"0",""
"0","# Make into cube"
"0","I = length(unique(sampleInfo$subject))"
"0","J = ncol(df_clr)"
"0","K = length(unique(sampleInfo$Days))"
"0","X = array(0L, c(I,J,K))"
"0","timepoints = sampleInfo %>% arrange(Days) %>% select(Days) %>% unique() %>% pull()"
"0",""
"0","for(k in 1:K){"
"0","  Day = timepoints[k]"
"0","  X[,,k] = cbind(df_clr, sampleInfo) %>% as_tibble() %>% mutate(subject=as.character(subject)) %>% filter(Days == Day) %>% select(c(colnames(df_clr),subject)) %>% right_join(subjectMeta) %>% arrange(subject) %>% select(-colnames(subjectMeta)) %>% as.matrix()"
"0","}"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"0","# Mask based on shared subjects for BMI and WHZ"
"0","X_bmi = X[subjectMeta$subject %in% homogenized_subjectMeta_bmi$subject,,]"
"0","X_whz = X[subjectMeta$subject %in% homogenized_subjectMeta_whz$subject,,]"
"0",""
"0","# Center and scale"
"0","X_bmi_cnt = parafac4microbiome::multiwayCenter(X_bmi, mode=1)"
"0","X_bmi_cnt_scl = parafac4microbiome::multiwayScale(X_bmi_cnt, mode=2)"
"0",""
"0","X_whz_cnt = parafac4microbiome::multiwayCenter(X_whz, mode=1)"
"0","X_whz_cnt_scl = parafac4microbiome::multiwayScale(X_whz_cnt, mode=2)"
"0",""
"0","milk_df_bmi = X_bmi_cnt_scl"
"0","milk_df_whz = X_whz_cnt_scl"
"0","milk_taxonomy = taxonomy_filtered"
"0","milk_timepoints = timepoints"
"0",""
"0","# Milk metabolomics"
"0","df = read.csv(""./Data/BMI/milkMetabNumeric.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","taxonomy = read.csv(""./Data/BMI/milk_metab_CAS_numbers.csv"", header=TRUE, sep="","") %>% as_tibble()"
"0","sampleInfo = read.csv(""./Data/BMI/milkMetab_sampleMeta.csv"", header=FALSE, sep="" "") %>% as_tibble()"
"0","colnames(sampleInfo) = c(""RCID"", ""BMI"", ""BMI.group"", ""Days"", ""Gestational.age"", ""C.section"", ""AB.infant"", ""AB.mother"", ""Secretor"", ""Lewis"", ""subject"")"
"0","metaboliteCategories = read.csv(""./Data/BMI/Metabolite_categories.txt"", sep=""\t"") %>% as_tibble()"
"0","metaboliteCategories = metaboliteCategories %>% mutate(Metabolite = vctrs::vec_as_names(Metabolite, repair=""universal_quiet""))"
"0",""
"0","# Make subject metadata"
"0","subjectMeta = sampleInfo %>% select(subject, BMI, BMI.group, C.section, Secretor, Lewis) %>% unique() %>% mutate(subject=as.character(subject)) %>% arrange(subject)"
"0",""
"0","# Remove duplicates"
"0","drop = c(61,81,146)"
"0","subjectMeta = subjectMeta %>% mutate(index=1:nrow(.)) %>% filter(!index %in% drop) %>% select(-index) %>% arrange(subject)"
"0",""
"0","# Log transform"
"0","df_log = log(df)"
"0",""
"0","# Make into cube"
"0","I = length(unique(sampleInfo$subject))"
"0","J = ncol(df_log)"
"0","K = length(unique(sampleInfo$Days))"
"0","X = array(0L, c(I,J,K))"
"0","timepoints = sampleInfo %>% arrange(Days) %>% select(Days) %>% unique() %>% pull()"
"0",""
"0","for(k in 1:K){"
"0","  Day = timepoints[k]"
"0","  X[,,k] = cbind(df_log, sampleInfo) %>% as_tibble() %>% mutate(subject=as.character(subject)) %>% filter(Days == Day) %>% select(c(colnames(df_log),subject)) %>% right_join(subjectMeta) %>% arrange(subject) %>% select(-colnames(subjectMeta)) %>% as.matrix()"
"0","}"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"1","[38;5;255mJoining with `by = join_by(subject)`[39m
"
"0","# Mask based on shared subjects for BMI and WHZ"
"0","X_bmi = X[subjectMeta$subject %in% homogenized_subjectMeta_bmi$subject,,]"
"0","X_whz = X[subjectMeta$subject %in% homogenized_subjectMeta_whz$subject,,]"
"0",""
"0","# Center and scale"
"0","X_bmi_cnt = parafac4microbiome::multiwayCenter(X_bmi, mode=1)"
"0","X_bmi_cnt_scl = parafac4microbiome::multiwayScale(X_bmi_cnt, mode=2)"
"0",""
"0","X_whz_cnt = parafac4microbiome::multiwayCenter(X_whz, mode=1)"
"0","X_whz_cnt_scl = parafac4microbiome::multiwayScale(X_whz_cnt, mode=2)"
"0",""
"0","milkMetab_df_bmi = X_bmi_cnt_scl"
"0","milkMetab_df_whz = X_whz_cnt_scl"
"0","milkMetab_taxonomy = taxonomy"
"0","milkMetab_timepoints = timepoints"
"0",""
"0","# Fix milkMetab feature annotations"
"0","df = milkMetab_taxonomy %>% mutate(Metabolite = make.names(X), CAS.Registry = make.names(CAS.Registry)) %>% left_join(metaboliteCategories)"
"1","[38;5;255mJoining with `by = join_by(Metabolite)`[39m
"
"0","# Fix mismatches by hand"
"0","df[df$Metabolite == ""X2.Aminobutyrate"",""Class""] = ""Amino acids and derivatives"""
"0","df[df$Metabolite == ""X2.Fucosyllactose"",""Class""] = ""Oligosaccharides"""
"0","df[df$Metabolite == ""X2.Hydroxybutyrate"",""Class""] = ""Amino acids and derivatives"""
"0","df[df$Metabolite == ""X2.Oxoglutarate"",""Class""] = ""Energy related"""
"0","df[df$Metabolite == ""X3.Fucosyllactose"",""Class""] = ""Oligosaccharides"""
"0","df[df$Metabolite == ""X3SL.partial"",""Class""] = ""Oligosaccharides"""
"0","df[df$Metabolite == ""X6SL.partial"",""Class""] = ""Oligosaccharides"""
"0","df[df$Metabolite == ""Methionine"",""Class""] = ""Amino acids and derivatives"""
"0","df[70,""Metabolite""] = ""tau.Methylhistidine"" # Fix non-ascii tau character"
"0",""
"0","milkMetab_featureMeta = df %>% select(-X)"
"0",""
"0","# # Put into Z"
"0","# datasets = list(faeces_df_bmi, milk_df_bmi, milkMetab_df_bmi)"
"0","# modes = list(c(1,2,3),c(1,4,5),c(1,6,7))"
"0","# Zbmi = setupCMTFdata(datasets, modes, normalize=TRUE)"
"0","# "
"0","# datasets = list(faeces_df_whz, milk_df_whz, milkMetab_df_whz)"
"0","# modes = list(c(1,2,3),c(1,4,5),c(1,6,7))"
"0","# Zwhz = setupCMTFdata(datasets, modes, normalize=TRUE)"
"0","# "
"0","# Jakobsen2025 = list(""Zbmi""=Zbmi,"
"0","#                     ""subjectMeta_BMI""=homogenized_subjectMeta_bmi,"
"0","#                     ""Zwhz""=Zwhz,"
"0","#                     ""subjectMeta_WHZ""=homogenized_subjectMeta_whz,"
"0","#                     ""infant_faecal_microbiome_taxonomy""=faeces_taxonomy,"
"0","#                     ""milk_microbiome_taxonomy""=milk_taxonomy,"
"0","#                     ""milk_metabolomics_features""=milkMetab_featureMeta)"
