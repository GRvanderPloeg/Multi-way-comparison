---
title: "microbiomeAnalysis"
output: html_document
date: "2023-09-05"
---

```{r libraries}
library(phyloseq)
library(tidyverse)
library(vegan)
library(ape)
library(ggpubr)
```

```{r load phyloseq object and convert}
processedGeorgiou = readRDS("./Data/AP/cytokines_homogenized.RDS")
microbiome_cnt_scl = readRDS("./Data/AP/microbiome_homogenized.RDS")
taxonomy_processed = readRDS("./Data/AP/taxonomy_homogenized.RDS")
```

```{r svd}
USV = svd(microbiome_cnt_scl)
```

```{r number of components}
plot(1:length(USV$d), USV$d)
```

```{r plot the model}
scores = USV$u %*% diag(USV$d)
loadings = USV$v

prepMode1 = processedGeorgiou$mode1 %>% mutate(Component_1 = scores[,1], Component_2 = scores[,2]) %>% arrange(PainS_NopainA, SubjectID) %>% mutate(index=1:nrow(.))
prepMode2 = taxonomy_processed %>% mutate(Component_1 = loadings[,1], Component_2 = loadings[,2]) %>% arrange(V2, V8) %>% mutate(index=1:nrow(.))

a = prepMode1 %>% ggplot(aes(x=index,y=Component_1,fill=as.factor(PainS_NopainA))) + geom_bar(stat="identity")
b = prepMode2 %>% as_tibble() %>% ggplot(aes(x=index,y=Component_1,fill=as.factor(V2))) + geom_bar(stat="identity")
c = prepMode1 %>% ggplot(aes(x=index,y=Component_2,fill=as.factor(PainS_NopainA))) + geom_bar(stat="identity")
d = prepMode2 %>% as_tibble() %>% ggplot(aes(x=index,y=Component_2,fill=as.factor(V2))) + geom_bar(stat="identity")

ggarrange(a,b,c,d)

Xhat = tcrossprod(scores[,c(1,2)],loadings[,c(1,2)])
varExp = sum(Xhat^2) / sum(microbiome_cnt_scl^2)
```

```{r compare with metadata}
cytokines_meta_data = read.csv("./Data/AP/input_deduplicated_metadata_RvdP.csv", sep=" ", header=FALSE) %>% as_tibble()
colnames(cytokines_meta_data) = c("SubjectID", "Visit", "Gender", "Age", "Pain_noPain", "case_control")

otherMeta = read.csv("./Data/AP/Root_meta_data_parafac.txt", sep="\t") %>% as_tibble() %>% select(-Gender)
timepoints = c(-6, -3, 0, 1, 6, 13)

normalSubjectLoadings = prepMode1 %>% as_tibble() %>% left_join(otherMeta, by="SubjectID")

uncorrectedP = matrix(NA, nrow=2, ncol=4)

# Gender
uncorrectedP[1,1] = wilcox.test(normalSubjectLoadings %>% filter(Gender=="M") %>% select(Component_1) %>% pull(), normalSubjectLoadings %>% filter(Gender=="F") %>% select(Component_1) %>% pull())$p.value
uncorrectedP[2,1] = wilcox.test(normalSubjectLoadings %>% filter(Gender=="M") %>% select(Component_2) %>% pull(), normalSubjectLoadings %>% filter(Gender=="F") %>% select(Component_2) %>% pull())$p.value

# Age
uncorrectedP[1,2] = cor.test(normalSubjectLoadings$Component_1, normalSubjectLoadings$Age.x)$p.value
uncorrectedP[2,2] = cor.test(normalSubjectLoadings$Component_2, normalSubjectLoadings$Age.x)$p.value

# DMFT
uncorrectedP[1,3] = cor.test(normalSubjectLoadings$Component_1, normalSubjectLoadings$DMFT)$p.value
uncorrectedP[2,3] = cor.test(normalSubjectLoadings$Component_2, normalSubjectLoadings$DMFT)$p.value

# pain-noPain
uncorrectedP[1,4] = wilcox.test(normalSubjectLoadings %>% filter(PainS_NopainA.x=="S") %>% select(Component_1) %>% pull(), normalSubjectLoadings %>% filter(PainS_NopainA.x=="A") %>% select(Component_1) %>% pull())$p.value
uncorrectedP[2,4] = wilcox.test(normalSubjectLoadings %>% filter(PainS_NopainA.x=="S") %>% select(Component_2) %>% pull(), normalSubjectLoadings %>% filter(PainS_NopainA.x=="A") %>% select(Component_2) %>% pull())$p.value

print(uncorrectedP)
correctedP = matrix(p.adjust(uncorrectedP, "BH"), nrow=2, ncol=4)
print(correctedP)
```
